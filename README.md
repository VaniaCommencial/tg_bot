## Telegram бот: мультимодальный (фото + текст) на PTB + Gemini

### Возможности
- Новый диалог при получении фото с подписью (1 фото = 1 диалог)
- Уточняющие текстовые сообщения продолжают текущий диалог
- История диалогов в локальном JSON (14 дней)
- Команды: /start, /help, /history, /dialog <id> [full], /clear (заглушка)

### Требования
- Python 3.10+
- Зависимости:
```
pip install -r requirements.txt
```

### .env
Создайте файл `.env` в корне проекта со значениями:
```
TELEGRAM_TOKEN=...
GEMINI_API_KEY=...

# Опционально
ADMIN_CHAT_IDS=
DATA_DIR=data
LOGS_DIR=logs
RETENTION_DAYS=14
IDLE_TIMEOUT_MINUTES=60
SYSTEM_PROMPT_PATH=bot/system_prompt.txt
```

### Запуск
```
python main.py
```

### Базовый сценарий тестирования
1. Отправьте `/start` — получите приветствие и предупреждение о контенте
2. Отправьте `/help` — получите инструкцию и список команд
3. Отправьте фото с подписью (например, «Что здесь происходит?»)
   - Бот создаст новый диалог, отправит запрос в модель и вернет ответ
4. Отправьте текст (например, «А что еще?») — бот продолжит текущий диалог
5. Отправьте новое фото с подписью — начнется новый диалог
6. Посмотрите историю: `/history [N]`
7. Посмотрите диалог: `/dialog <id>` или полный `/dialog <id> full`

### Где хранятся данные
- `data/users/<chat_id>.json` — профиль пользователя и индекс диалогов
- `data/dialogs/<chat_id>/<dialog_id>.json` — полный диалог

### Структура проекта
```
tg_bot/
  bot/
    app.py          # сборка и регистрация хендлеров PTB
    config.py       # загрузка конфигурации из env
    gemini.py       # обертка над Google Generative AI
    handlers.py     # команды и единый роутер сообщений
    session.py      # in-memory менеджер сессий
    storage.py      # JSON-хранилище пользователей и диалогов
    __init__.py
  data/             # локальное хранилище JSON
  logs/             # логи приложения
  main.py           # точка входа, запуск polling
  requirements.txt
  LICENSE
```

### Ограничения и известные особенности
- Если регион заблокирован для Gemini API — бот вернет понятное сообщение
- Фото не сохраняются на диск — храним только метаданные и текст истории
- `/clear` пока заглушка (планируется реализация)

### Диагностика
- Консольные логи при запуске и обработке сообщений
- Проверьте наличие файлов в `data/` после взаимодействия

### План дальнейших доработок
- Реализация очистки истории (`/clear`) и ретенции 14 дней
- Ретраи и таймауты для запросов к модели
- Админ-статистика (`/stats`) и расширенная история
- Улучшение выжимок диалогов и поиск по истории

### Системный промт
- Файл: `bot/system_prompt.txt`
- Можно отредактировать под ваши нужды; бот подхватит его при старте.


